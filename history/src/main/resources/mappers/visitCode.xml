<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hifive.history.repository.mappers.visitCode">
	<select id="hi_getToday" parameterType="String" resultType="int">
		SELECT COUNT(*) AS TOTAL_CNT
	 	 FROM(
	  			SELECT SEQ, ID, V_ID, VDATE, SEX, AREA, BIRTH 
	 			FROM VISIT_H 
	  			WHERE ID = #{id} 
	  			AND VDATE = TO_CHAR(SYSDATE, 'YY/MM/DD')
	 	) 
	</select>
	<select id="hi_getTotal" parameterType="String" resultType="int">
		SELECT COUNT(*) AS TOTAL_CNT
		 FROM(
				SELECT SEQ, ID, V_ID, VDATE, SEX, AREA, BIRTH 
				FROM VISIT_H 
				WHERE ID = #{id}
		)
	</select>
	<select id="hi_getTodayVisit" parameterType="hashmap" resultType="hashmap">
	<![CDATA[
	SELECT A.CUR_DATE AS CUR_DATE, NVL(A.CNT+B.CNT,0) AS CNT 
	FROM
	  (
	  SELECT TO_CHAR((TO_DATE(#{enddate}, 'YYYYMMDD')-LEVEL), 'YYYYMMDD') AS CUR_DATE,
	  0 AS CNT 
	  FROM DUAL
	  CONNECT BY LEVEL <=7
	  ) A
	LEFT OUTER JOIN
	(
	  SELECT TO_CHAR(VDATE, 'YYYYMMDD') AS CUR_DATE,COUNT(*) AS CNT
	  FROM VISIT_H
	  WHERE V_ID = #{id}
	  AND VDATE BETWEEN TO_DATE(#{enddate}, 'YYYYMMDD')-7 AND TO_DATE(#{enddate}, 'YYYYMMDD')
	  GROUP BY TO_CHAR(VDATE, 'YYYYMMDD')
	  
	)B
	ON A.CUR_DATE = B.CUR_DATE
	ORDER BY CUR_DATE ASC
	]]>
	</select> 
</mapper>